---
layout: doc
title: 模块开发
description: 学习如何为 SakitinSU 开发和构建自定义模块
outline: deep
---

# 模块开发指南

SakitlinSU 提供了一个与 `Magisk` 和 `KernelSU` 类似的模块机制。
在 SakitlinSU 中，即为 `SakitlinSU Systemless`，简称 `SSUS`。[^1]

SakitlinSU 模块的加载和运行行机制与 `Magisk` 和 `KernelSU` 几乎完全相同， 这意味着你只要熟悉 `Magisk` 模块的开发，就可以轻松上手。
只需要了解 SakitlinSU 的一些 [[与 Magisk 模块的差异]] 即可。

## 与 Magisk 模块的差异

SakitlinSU 中引入了 ASCII 颜色转义[^2]，这意味着你可以在 `modeule.prop` 或 `customize.sh` 中编写 `ASCII` 控制码来改变文本颜色。
例如，你可以在 `module.prop` 中使用以下代码来设置模块

```properties {4,8}
id=ssu_cmd_ext
name=Command Set Extension
version=Auto-generated by SSU
versionAnsi=\e[1mAuto-generated\e[0m by SSU
versionCode=1
author=SSU Developers (OOM. WG.)
description=Add coreutils, busybox, and bash to /system/bin.
descriptionAnsi=Add \e[1mcoreutils, busybox, and bash\e[0m to \e[1m/system/bin\e[0m.
```

在编写模块时不建议直接修改 `version` 和 `description` 中的原有字段，我们对此做了兼容性处理，
你可以直接使用 `versionAnsi` 和 `descriptionAnsi` 来使用 ASCII 控制码。<mark>SakitlinSU 会优先解析这些字段。</mark>

::: details 展开查看渲染效果
![module.prop 渲染效果](/assets/img/module_prop.jpg)
:::

## 模块Web界面

SakitlinSU 提供了一个模块 Web 界面，允许用户通过浏览器与模块进行交互。
SakitlinSU 提供了一个模块 Web 界面，运行在Web界面与模块交互 详见 [模块 WebUI](./webui.md)。

## SakitinSU 模块

SakitlinSU 在刷入后会被放置在 `/data/adb/modules/` 目录下。且满足以下的目录结构

```txt
/data/adb/modules
├── .
├── .
|
├── $MODID                  <-- 文件夹以模块的 ID 命名
│   │
│   │      *** 模块 ID ***
│   │
│   ├── module.prop         <-- 此文件存储模块的元数据（metadata）
│   │
│   │      *** 主要内容 ***
│   │
│   ├── system              <-- 如果 skip_mount 不存在，将挂载此文件夹
│   │   ├── ...
│   │   ├── ...
│   │   └── ...
│   │
│   ├── zygisk              <-- 此文件夹包含模块的 Zygisk native 库
│   │   ├── arm64-v8a.so
│   │   ├── armeabi-v7a.so
│   │   ├── x86.so
│   │   ├── x86_64.so
│   │   └── unloaded        <-- 如果存在，则 native 库不兼容
│   │
│   │      *** 状态标志 ***
│   │
│   ├── skip_mount          <-- 如果存在，Magisk 将不会挂载您的 system 文件夹
│   ├── disable             <-- 如果存在，模块将被禁用
│   ├── remove              <-- 如果存在，模块将在下次重新启动时删除
│   │
│   │      *** 可选文件 ***
│   │
│   ├── post-fs-data.sh     <-- 此脚本将在 post-fs-data 中执行
│   ├── service.sh          <-- 此脚本将在 late_start 服务中执行
|   ├── uninstall.sh        <-- 当 Magisk 删除您的模块时，将执行此脚本
│   ├── system.prop         <-- resetprop 将此文件中的属性作为系统属性加载
│   ├── sepolicy.rule       <-- 其他自定义 sepolicy 规则
│   │
│   │      *** 自动生成，请勿手动创建或修改 ***
│   │
│   ├── vendor              <-- $MODID/system/vendor 的符号链接
│   ├── product             <-- $MODID/system/product 的符号链接
│   ├── system_ext          <-- $MODID/system/system_ext 的符号链接
│   │
│   │      *** 允许任何其他的文件/文件夹 ***
│   │
│   ├── ...
│   └── ...
|
├── 其他模块
│   ├── .
│   └── .
├── .
├── .
```

### module.prop

这是 `module.prop` 必须遵守的格式,但是 SakitlinSU 对某些字段做了兼容性处理。`module.prop ` 会被判断为是否为模块标志，如果
`刷入的模块` 中不存在 `module.prop` 文件，则 SakitlinSU 会将不会其视为一个模块。

```properties
id=<字符串> <string>
name=<字符串> <string>
version=<字符串> <string>
versionAnsi=<字符串> <string>          <-- SakitlinSU 支持 ASCII 控制码
versionCode=<整数> <int>
author=<字符串> <string>
description=<字符串> <string>
descriptionAnsi=<字符串> <string>      <-- SakitlinSU 支持 ASCII 控制码
updateJson=<链接> <url> (可选)
```

- `id` 必须匹配此正则表达式：`^[a-zA-Z][a-zA-Z0-9._-]+$`

示例: `a_module` <Badge type="tip"> ✓ </Badge> ，`a.module` <Badge type="tip"> ✓ </Badge> ，
`module-101` <Badge type="tip"> ✓ </Badge> ，`a module` <Badge type="danger"> ✗ </Badge> ，
`1_module` <Badge type="danger"> ✗ </Badge> ，`-a-module` <Badge type="danger"> ✗ </Badge>

- versionCode 必须是一个整数，用于比较版本。
- 其他未在上面提到的内容可以是任何单行字符串。
- 请确保使用 `UNIX（LF）`换行类型，而不是 `Windows（CR + LF）`或 `Macintosh（CR）`。

[^1]: systemless 机制是一种无需直接修改系统分区即可实现系统功能增强的方法，常用于提升系统安全性和可维护性。
[^2]: ASCII
控制码是一种用于控制文本显示样式的字符编码方式，常用于终端和控制台应用程序中。详见[维基百科](https://en.wikipedia.org/wiki/ANSI_escape_code)